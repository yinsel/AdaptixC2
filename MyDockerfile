FROM m.daocloud.io/docker.io/library/golang:1.24.4-bookworm AS builder

ENV DEBIAN_FRONTEND=noninteractive \
    GOPROXY=https://mirrors.aliyun.com/goproxy/,direct

RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources && \ 
    sed -i 's/security.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources

RUN apt-get update && apt-get upgrade -y && apt-get install -y mingw-w64 make libssl-dev qt6-base-dev qt6-websockets-dev sudo libcap2-bin build-essential checkinstall zlib1g-dev libssl-dev qt6-declarative-dev qt6-scxml-dev

WORKDIR /app

COPY . .

RUN make server
RUN make extenders

FROM m.daocloud.io/docker.io/library/golang:1.24.4-bookworm AS runtime

ENV DEBIAN_FRONTEND=noninteractive \
    GOPROXY=https://mirrors.aliyun.com/goproxy/,direct

RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources && \ 
    sed -i 's/security.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources

RUN apt-get update && apt-get upgrade -y && apt-get install -y mingw-w64 make unzip && rm -rf /var/lib/apt/lists/*

# support win7
# if local
# COPY ./go-win7 /usr/lib/go-win7
RUN wget https://gh-proxy.com/https://github.com/XTLS/go-win7/releases/download/patched-1.24.4/go-for-win7-linux-amd64.zip -O /tmp/go-win7.zip && \
    unzip /tmp/go-win7.zip -d /tmp/go-win7 && \
    mv /tmp/go-win7 /usr/lib/ && \
    mv /usr/lib/go-win7/bin/go /usr/lib/go-win7/go

COPY --from=builder /app/dist /app

WORKDIR /app

CMD ["./adaptixserver", "-profile", "profile.json"]